<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Automa√ß√£o WhatsApp</title>
    <!-- Carrega Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom scrollbar for chat list */
        .chat-list::-webkit-scrollbar {
            width: 6px;
        }
        .chat-list::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
        .chat-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 mr-3 text-green-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12.001 2c-5.507 0-9.999 4.493-9.999 10.001 0 1.764.484 3.444 1.408 4.909l-1.076 3.948 4.072-1.056c1.396.793 2.984 1.258 4.629 1.258 5.507 0 10.001-4.494 10.001-10.001s-4.494-10.001-10.001-10.001zm5.176 13.567c-.287.797-.899 1.135-1.558 1.407-.584.244-1.127.424-2.858.375-.688-.019-1.94-.035-3.32-.97-2.072-1.39-3.447-3.69-3.461-3.71-.164-.225-.972-1.298-.972-2.437s.545-1.745.74-.961c.196.786.376.965.584 1.218.209.255.44.488.636.696.195.207.394.46.618.708.224.249.534.582.883.945.438.46 1.054 1.144 1.879 1.543.901.436 1.708.57 2.399.57.69 0 1.018-.266 1.226-.52.207-.255.761-.925.761-1.734s-.972-1.298-1.378-1.777c-.407-.478-.853-.872-.796-1.171.056-.3.264-.478.472-.696.207-.21.438-.344.634-.522.196-.178.455-.42.678-.42.224 0 .394.103.558.281.163.179.972 2.389 1.167 3.01.196.621.254 1.343.195 1.543-.058.2-.472.437-.679.646zm-5.176-1.566c.204 0 .408 0 .612 0s.408 0 .612 0l0 0z"/></svg>
                Painel de Automa√ß√£o
            </h1>
            <p class="text-gray-500">Gerencie sua conex√£o e envie mensagens atrav√©s da sua API local.</p>
        </header>

        <!-- Se√ß√£o de Status e Reconex√£o -->
        <section class="bg-white p-6 rounded-lg shadow-xl mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Status da Conex√£o</h2>
            <div class="flex items-center space-x-4">
                <span id="status-indicator" class="w-4 h-4 rounded-full bg-yellow-400"></span>
                <span id="status-message" class="text-gray-600 font-medium">Verificando...</span>
            </div>
            <button onclick="reconnectClient()" id="reconnect-btn" class="mt-4 px-4 py-2 bg-red-500 text-white font-semibold rounded-md hover:bg-red-600 transition duration-150 disabled:bg-red-300">
                Reconectar / For√ßar Novo QR
            </button>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Se√ß√£o de Envio de Mensagens -->
            <section class="bg-white p-6 rounded-lg shadow-xl">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Enviar Mensagem Manualmente</h2>
                <form id="send-message-form" onsubmit="sendMessage(event)">
                    <div class="mb-4">
                        <label for="chat-id" class="block text-sm font-medium text-gray-700 mb-1">ID do Chat / Grupo (ou N√∫mero)</label>
                        <input type="text" id="chat-id" name="number" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500" 
                               placeholder="Ex: 5511999998888@c.us ou 1234567890@g.us">
                        <p class="text-xs text-gray-500 mt-1">Use a lista ao lado para preencher automaticamente.</p>
                    </div>
                    <div class="mb-4">
                        <label for="message-body" class="block text-sm font-medium text-gray-700 mb-1">Mensagem</label>
                        <textarea id="message-body" name="message" rows="4" required 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500" 
                                    placeholder="Digite a mensagem que deseja enviar..."></textarea>
                    </div>
                    <button type="submit" id="send-btn" disabled
                            class="w-full px-4 py-2 bg-green-500 text-white font-bold rounded-md hover:bg-green-600 transition duration-150 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <span id="send-btn-text">Enviar Mensagem</span>
                    </button>
                    <p id="send-message-feedback" class="mt-3 text-sm font-medium"></p>
                </form>
            </section>

            <!-- Se√ß√£o de Lista de Chats -->
            <section class="bg-white p-6 rounded-lg shadow-xl">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex justify-between items-center">
                    Contatos & Grupos
                    <button onclick="loadChats()" class="text-sm text-blue-500 hover:text-blue-700 font-medium">
                        Atualizar Lista
                    </button>
                </h2>
                <div id="chats-list" class="chat-list h-80 overflow-y-auto border border-gray-200 rounded-md p-2">
                    <p class="text-center text-gray-500">Clique em "Atualizar Lista" para carregar seus chats.</p>
                </div>
            </section>
        </div>

        <!-- Se√ß√£o de QR Code (Modal Simples) -->
        <div id="qr-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full text-center">
                <h3 class="text-xl font-bold mb-4 text-red-600">‚ö† Conex√£o Perdida</h3>
                <p class="text-gray-700 mb-4">Escaneie o QR Code no console do seu servidor Node.js ou clique em **"Reconectar"** para gerar um novo.</p>
                <button onclick="document.getElementById('qr-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <script>
        // CORRE√á√ÉO CR√çTICA: Altera o endere√ßo da API para o URL do Render fornecido.
        const API_URL = 'https://automacao2-8mi9.onrender.com/api';
        
        const statusIndicator = document.getElementById('status-indicator');
        const statusMessage = document.getElementById('status-message');
        const sendBtn = document.getElementById('send-btn');
        const sendBtnText = document.getElementById('send-btn-text');
        const sendFeedback = document.getElementById('send-message-feedback');
        const chatsList = document.getElementById('chats-list');
        const qrModal = document.getElementById('qr-modal');
        const reconnectBtn = document.getElementById('reconnect-btn');
        let isConnected = false;

        // Fun√ß√£o utilit√°ria para chamar a API
        async function apiFetch(endpoint, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: { 'Content-Type': 'application/json' },
            };
            if (data) {
                options.body = JSON.stringify(data);
            }
            try {
                const response = await fetch(`${API_URL}${endpoint}`, options);
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || 'Erro desconhecido da API');
                }
                return result;
            } catch (error) {
                console.error(`Erro ao acessar ${endpoint}:`, error);
                throw error;
            }
        }

        // 1. Verifica o Status do Bot
        async function checkStatus() {
            try {
                const status = await apiFetch('/status');
                isConnected = status.connected;

                if (isConnected) {
                    statusIndicator.classList.remove('bg-yellow-400', 'bg-red-500');
                    statusIndicator.classList.add('bg-green-500');
                    statusMessage.textContent = status.statusMessage || 'Conectado. API pronta para uso.';
                    sendBtn.disabled = false;
                    reconnectBtn.disabled = false;
                    qrModal.classList.add('hidden');
                } else {
                    statusIndicator.classList.remove('bg-yellow-400', 'bg-green-500');
                    statusIndicator.classList.add('bg-red-500');
                    statusMessage.textContent = status.statusMessage || 'Desconectado. Sess√£o expirada ou n√£o inicializada.';
                    sendBtn.disabled = true;
                    reconnectBtn.disabled = false;
                    // Se estiver aguardando QR Code, pode mostrar o modal (embora o QR code s√≥ esteja no console)
                    if (status.qrCode) {
                         qrModal.classList.remove('hidden');
                    }
                }
            } catch (error) {
                statusIndicator.classList.remove('bg-green-500');
                statusIndicator.classList.add('bg-red-500');
                statusMessage.textContent = `Erro de Conex√£o: O servidor Node.js est√° offline.`;
                sendBtn.disabled = true;
                reconnectBtn.disabled = true;
            }
        }

        // 2. Envia Mensagem
        async function sendMessage(event) {
            event.preventDefault();
            
            sendFeedback.textContent = '';
            sendFeedback.classList.remove('text-green-600', 'text-red-600', 'text-blue-600'); // Limpa cores
            sendBtn.disabled = true;
            sendBtnText.textContent = 'Enviando...';

            const number = document.getElementById('chat-id').value.trim();
            const message = document.getElementById('message-body').value.trim();

            if (!number || !message) {
                sendFeedback.textContent = 'Erro: Por favor, preencha o ID do Chat/N√∫mero e a mensagem.';
                sendFeedback.classList.add('text-red-600');
                sendBtn.disabled = false;
                sendBtnText.textContent = 'Enviar Mensagem';
                return;
            }

            try {
                const result = await apiFetch('/send-message', 'POST', { number, message });
                
                sendFeedback.textContent = `Sucesso! Mensagem enviada √†s ${new Date().toLocaleTimeString('pt-BR')}.`;
                sendFeedback.classList.add('text-green-600');
                
                // Limpa apenas a mensagem, mantendo o ID do chat
                document.getElementById('message-body').value = ''; 

            } catch (error) {
                sendFeedback.textContent = `Falha ao enviar: ${error.message}`;
                sendFeedback.classList.add('text-red-600');
                
            } finally {
                sendBtn.disabled = isConnected ? false : true; // Reabilita se estiver conectado
                sendBtnText.textContent = 'Enviar Mensagem';
            }
        }

        // 3. Carrega Contatos e Grupos
        async function loadChats() {
            if (!isConnected) {
                chatsList.innerHTML = `<p class="text-center text-red-500 p-2">N√£o √© poss√≠vel carregar chats: WhatsApp est√° desconectado.</p>`;
                return;
            }

            chatsList.innerHTML = '<p class="text-center text-blue-500 p-2">Carregando chats...</p>';

            try {
                const [contactsResult, groupsResult] = await Promise.all([
                    apiFetch('/contacts'),
                    apiFetch('/groups')
                ]);

                chatsList.innerHTML = '';
                
                // 3.1 Fun√ß√£o para renderizar item da lista
                const renderItem = (name, id, isGroup = false) => {
                    const listItem = document.createElement('div');
                    listItem.className = `p-2 cursor-pointer border-b last:border-b-0 hover:bg-gray-100 transition duration-100 ${isGroup ? 'font-semibold' : ''}`;
                    listItem.innerHTML = `
                        <span class="text-gray-800">${isGroup ? 'üë•' : 'üë§'} ${name}</span><br>
                        <span class="text-xs text-gray-500 truncate" title="${id}">${id}</span>
                    `;
                    listItem.onclick = () => {
                        document.getElementById('chat-id').value = id;
                        document.getElementById('chat-id').focus();
                        sendFeedback.textContent = `ID preenchido com: ${name}`;
                        sendFeedback.classList.remove('text-red-600', 'text-green-600');
                        sendFeedback.classList.add('text-blue-600');
                    };
                    return listItem;
                };

                // 3.2 Renderiza Grupos
                if (groupsResult.length > 0) {
                    const groupTitle = document.createElement('p');
                    groupTitle.className = 'text-sm font-bold text-indigo-600 py-1 px-2 mt-2 sticky top-0 bg-white border-b';
                    groupTitle.textContent = 'Grupos';
                    chatsList.appendChild(groupTitle);
                    groupsResult.forEach(g => chatsList.appendChild(renderItem(g.name, g.id, true)));
                }

                // 3.3 Renderiza Contatos
                if (contactsResult.length > 0) {
                    const contactTitle = document.createElement('p');
                    contactTitle.className = 'text-sm font-bold text-indigo-600 py-1 px-2 mt-2 sticky top-0 bg-white border-b';
                    contactTitle.textContent = 'Contatos Individuais';
                    chatsList.appendChild(contactTitle);
                    contactsResult.forEach(c => chatsList.appendChild(renderItem(c.name || c.number, c.id, false)));
                }

                if (groupsResult.length === 0 && contactsResult.length === 0) {
                    chatsList.innerHTML = `<p class="text-center text-gray-500 p-2">Nenhum chat encontrado.</p>`;
                }

            } catch (error) {
                chatsList.innerHTML = `<p class="text-center text-red-500 p-2">Erro ao carregar chats: ${error.message}</p>`;
            }
        }

        // 4. Reconecta o Cliente WhatsApp
        async function reconnectClient() {
            reconnectBtn.disabled = true;
            reconnectBtn.textContent = 'Reconectando...';
            sendFeedback.textContent = ''; // Limpa o feedback anterior

            try {
                await apiFetch('/reconnect', 'POST');
                statusMessage.textContent = 'Comando de reconex√£o enviado. Verifique o console do Render para o QR Code.';
                statusIndicator.classList.remove('bg-green-500', 'bg-red-500');
                statusIndicator.classList.add('bg-yellow-400');
                qrModal.classList.remove('hidden'); // Exibe o modal para instruir o usu√°rio a olhar o console
            } catch (error) {
                // CORRE√á√ÉO: Substitui alert() por mensagem na √°rea de feedback
                sendFeedback.textContent = `Erro ao solicitar reconex√£o: ${error.message}`;
                sendFeedback.classList.remove('text-green-600', 'text-blue-600');
                sendFeedback.classList.add('text-red-600');
            } finally {
                reconnectBtn.textContent = 'Reconectar / For√ßar Novo QR';
                // Deixa o bot√£o reabilitar ap√≥s o checkStatus
                setTimeout(checkStatus, 5000); 
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            // Verifica o status a cada 5 segundos
            setInterval(checkStatus, 5000); 
            checkStatus(); // Verifica o status imediatamente
        });
    </script>
</body>
</html>
