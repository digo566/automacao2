<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle WhatsApp Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; 
        }
        .container {
            max-width: 95%;
            padding: 1rem;
        }
        .header {
            background-color: #128C7E; 
            color: white;
            padding: 1rem;
            border-radius: 0.75rem 0.75rem 0 0;
        }
        .shadow-lg-custom {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Centraliza e estiliza o container do QR */
        #qrCodeDisplay {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            min-height: 200px; /* Garante espa√ßo */
        }
        #qrCodeDisplay img {
            width: 250px;
            height: 250px;
            border: 5px solid white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4">
    <div class="container w-full lg:w-3/4 xl:w-2/3 bg-white rounded-xl shadow-lg-custom mt-4">
        
        <header class="header flex justify-between items-center">
            <h1 class="text-2xl font-bold">ü§ñ Painel de Automa√ß√£o WhatsApp</h1>
            <button id="reconnectButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-lg transition duration-150">
                Reconectar
            </button>
        </header>

        <main class="p-6 space-y-6">
            
            <!-- Se√ß√£o de Status e QR Code -->
            <section class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Status do Bot</h2>
                <div class="flex items-center space-x-3 mb-4">
                    <div id="statusIndicator" class="w-4 h-4 rounded-full bg-red-500 animate-pulse"></div>
                    <p id="statusText" class="text-lg font-medium text-red-700">Desconectado</p>
                </div>
                
                <div id="qrCodeContainer" class="hidden bg-white p-4 rounded-lg">
                    <p class="text-center text-red-600 font-semibold mb-3">Escaneie o QR Code abaixo com seu celular:</p>
                    <div id="qrCodeDisplay" class="flex justify-center items-center">
                        <!-- O QR Code Base64 ser√° injetado aqui -->
                    </div>
                </div>
            </section>
            
            <!-- Formul√°rio de Envio de Mensagem -->
            <section class="bg-white p-4 rounded-lg border border-gray-200 shadow">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Enviar Mensagem Manual</h2>
                <form id="sendMessageForm" class="space-y-4">
                    <div>
                        <label for="chatId" class="block text-sm font-medium text-gray-700">ID do Chat / Grupo</label>
                        <input type="text" id="chatId" placeholder="Ex: 5511999998888@c.us ou ID_DO_GRUPO@g.us" required
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="messageContent" class="block text-sm font-medium text-gray-700">Conte√∫do da Mensagem</label>
                        <textarea id="messageContent" rows="3" placeholder="Digite sua mensagem aqui..." required
                                  class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-green-500 focus:border-green-500"></textarea>
                    </div>
                    <button type="submit" id="sendButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 disabled:bg-gray-400">
                        Enviar Mensagem
                    </button>
                </form>
            </section>
            
            <!-- Se√ß√£o de Listagem de Contatos/Grupos -->
            <section class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Contatos e Grupos</h2>
                <div class="flex space-x-2 mb-3">
                    <button id="updateListButton" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 disabled:bg-gray-400">
                        Atualizar Lista
                    </button>
                    <select id="listType" class="bg-white border border-gray-300 rounded-lg p-2">
                        <option value="contacts">Contatos</option>
                        <option value="groups">Grupos</option>
                    </select>
                </div>

                <div id="listContainer" class="h-64 overflow-y-auto border border-gray-300 bg-white rounded-md p-2 space-y-1 text-sm">
                    <p class="text-center text-gray-500 mt-4">Clique em "Atualizar Lista" para carregar.</p>
                </div>
            </section>
            
            <!-- Mensagens de Feedback -->
            <div id="feedbackMessage" class="mt-4 p-3 rounded-lg text-center font-medium hidden" role="alert"></div>

        </main>
    </div>

    <script>
        // =========================================================================
        // üö®üö®üö® PONTO DE MUDAN√áA CR√çTICO üö®üö®üö®
        // Voc√™ DEVE trocar 'http://localhost:3001/api' pelo endere√ßo P√öBLICO do seu servidor Node.js.
        // Se usar Render/Railway: 'https://seubot.onrender.com/api'
        // Se usar VPS: 'http://<IP_DO_SEU_VPS>:3001/api'
        // =========================================================================
        const API_BASE_URL = 'http://localhost:3001/api'; 
        // =========================================================================

        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const qrCodeContainer = document.getElementById('qrCodeContainer');
        const qrCodeDisplay = document.getElementById('qrCodeDisplay');
        const sendMessageForm = document.getElementById('sendMessageForm');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const sendButton = document.getElementById('sendButton');
        const reconnectButton = document.getElementById('reconnectButton');
        const updateListButton = document.getElementById('updateListButton');
        const listContainer = document.getElementById('listContainer');
        const listType = document.getElementById('listType');
        const chatIdInput = document.getElementById('chatId');

        function showFeedback(message, isError = false) {
            feedbackMessage.textContent = message;
            feedbackMessage.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
            if (isError) {
                feedbackMessage.classList.add('bg-red-100', 'text-red-800');
            } else {
                feedbackMessage.classList.add('bg-green-100', 'text-green-800');
            }
            // Oculta a mensagem ap√≥s 5 segundos
            setTimeout(() => feedbackMessage.classList.add('hidden'), 5000);
        }

        function updateStatus(connected, qrCodeBase64) {
            if (connected) {
                // Status de CONECTADO
                statusIndicator.classList.remove('bg-red-500', 'animate-pulse');
                statusIndicator.classList.add('bg-green-500');
                statusText.textContent = 'Conectado';
                statusText.classList.remove('text-red-700');
                statusText.classList.add('text-green-700');
                qrCodeContainer.classList.add('hidden');
                sendButton.disabled = false;
                updateListButton.disabled = false;
            } else {
                // Status de DESCONECTADO ou AGUARDANDO QR
                statusIndicator.classList.remove('bg-green-500');
                statusIndicator.classList.add('bg-red-500', 'animate-pulse');
                
                sendButton.disabled = true;
                updateListButton.disabled = true;

                if (qrCodeBase64) {
                    statusText.textContent = 'Aguardando QR Scan (Escaneie abaixo)';
                    statusText.classList.add('text-red-700');
                    qrCodeContainer.classList.remove('hidden');
                    
                    // Renderiza o QR Code
                    qrCodeDisplay.innerHTML = `<img src="data:image/png;base64,${qrCodeBase64}" alt="QR Code para WhatsApp Web">`;
                } else {
                    statusText.textContent = 'Desconectado/Inicializando';
                    statusText.classList.add('text-red-700');
                    qrCodeContainer.classList.add('hidden');
                    qrCodeDisplay.innerHTML = ''; // Limpa o QR Code
                }
            }
        }

        // Fun√ß√£o principal para verificar o status
        async function checkStatus() {
            // Verifica se a URL base ainda √© o padr√£o local, que causar√° o erro "Failed to fetch"
            if (API_BASE_URL.includes('localhost')) {
                console.error("ERRO CR√çTICO: A vari√°vel API_BASE_URL ainda est√° configurada para 'localhost'. Voc√™ DEVE troc√°-la pelo endere√ßo p√∫blico do seu servidor Cloud (Render/Railway/VPS)!");
            }

            try {
                // Tenta se conectar ao servidor da API
                const response = await fetch(`${API_BASE_URL}/status`);
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                const data = await response.json();
                // data.qrCode agora cont√©m a string Base64 se dispon√≠vel
                updateStatus(data.connected, data.qrCode); 
            } catch (error) {
                console.error('Erro ao verificar o status:', error);
                // Exibe erro se a conex√£o com a API falhar (provavelmente a URL est√° errada)
                statusText.textContent = 'Erro de Conex√£o: O servidor Node.js est√° offline ou a API_BASE_URL est√° errada.';
                statusText.classList.add('text-red-700');
                statusIndicator.classList.remove('bg-green-500');
                statusIndicator.classList.add('bg-red-500', 'animate-pulse');
                sendButton.disabled = true;
                updateListButton.disabled = true;
            }
        }

        // Enviar Mensagem
        sendMessageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const number = document.getElementById('chatId').value.trim();
            const message = document.getElementById('messageContent').value.trim();

            if (!number || !message) {
                showFeedback('Preencha o ID do Chat e a Mensagem.', true);
                return;
            }

            sendButton.textContent = 'Enviando...';
            sendButton.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/send-message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ number, message })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showFeedback('Mensagem enviada com sucesso!');
                    document.getElementById('messageContent').value = ''; 
                } else {
                    throw new Error(result.details || result.error || 'Falha desconhecida no envio.');
                }
            } catch (error) {
                console.error('Erro de Envio:', error);
                showFeedback(`Erro ao enviar: ${error.message}`, true);
            } finally {
                sendButton.textContent = 'Enviar Mensagem';
                // Verifica o status de conex√£o para reativar o bot√£o
                sendButton.disabled = !statusIndicator.classList.contains('bg-green-500');
            }
        });

        // Reconectar
        reconnectButton.addEventListener('click', async () => {
            if (!confirm('Tem certeza que deseja for√ßar a reconex√£o? Isso pode exigir um novo QR Code!')) {
                return;
            }
            reconnectButton.disabled = true;
            try {
                const response = await fetch(`${API_BASE_URL}/reconnect`, { method: 'POST' });
                const result = await response.json();
                if (response.ok && result.success) {
                    showFeedback('Comando de reconex√£o enviado. Aguarde...');
                    checkStatus(); 
                } else {
                    throw new Error(result.error || 'Falha na reconex√£o.');
                }
            } catch (error) {
                console.error('Erro ao reconectar:', error);
                showFeedback(`Erro ao tentar reconectar: ${error.message}`, true);
            } finally {
                reconnectButton.disabled = false;
            }
        });


        // Listar Contatos/Grupos
        updateListButton.addEventListener('click', async () => {
            const type = listType.value;
            const endpoint = type === 'contacts' ? 'contacts' : 'groups';
            listContainer.innerHTML = '<p class="text-center text-gray-500 mt-4">Carregando...</p>';
            updateListButton.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/${endpoint}`);
                if (!response.ok) {
                    throw new Error('Erro ao buscar lista.');
                }
                const data = await response.json();
                
                listContainer.innerHTML = ''; 
                
                if (data.length === 0) {
                    listContainer.innerHTML = `<p class="text-center text-gray-500 mt-4">Nenhum ${type === 'contacts' ? 'contato' : 'grupo'} encontrado.</p>`;
                    return;
                }
                
                data.forEach(item => {
                    const listItem = document.createElement('div');
                    listItem.className = 'p-2 rounded-md hover:bg-gray-100 cursor-pointer border-b border-gray-200';
                    
                    const displayId = item.id;
                    const displayName = item.name || (item.number ? `(${item.number})` : '[ID Desconhecido]');

                    listItem.innerHTML = `
                        <p class="font-semibold text-gray-800 truncate">${displayName}</p>
                        <p class="text-xs text-gray-500 truncate">ID: ${displayId}</p>
                    `;
                    
                    listItem.addEventListener('click', () => {
                        chatIdInput.value = displayId;
                        showFeedback(`ID ${displayName} copiado para o campo de envio!`, false);
                    });
                    
                    listContainer.appendChild(listItem);
                });

            } catch (error) {
                console.error('Erro ao listar:', error);
                listContainer.innerHTML = `<p class="text-center text-red-500 mt-4">Falha ao carregar a lista: ${error.message}</p>`;
            } finally {
                updateListButton.disabled = false;
            }
        });


        // Inicializa√ß√£o: Verifica o status a cada 5 segundos
        checkStatus(); 
        setInterval(checkStatus, 5000);
    </script>
</body>
</html>
