<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle do Bot WhatsApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            width: 100%;
            background-color: white;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        @media (max-width: 640px) {
            .container {
                padding: 20px;
            }
        }
        .section {
            padding: 20px;
            border-radius: 12px;
            background-color: #f9f9fb;
            margin-bottom: 24px;
        }
        .btn-primary {
            background-color: #25D366;
            color: white;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            transition: background-color 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            background-color: #128C7E;
        }
        .status-connected {
            background-color: #d1fae5;
            color: #065f46;
            font-weight: 700;
        }
        .status-disconnected {
            background-color: #fee2e2;
            color: #991b1b;
            font-weight: 700;
        }
        .qr-image img {
            max-width: 100%;
            height: auto;
            border: 4px solid #25D366;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">ü§ñ Painel de Controle WhatsApp Bot</h1>
        
        <!-- Se√ß√£o de Status -->
        <div class="section">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Status da Conex√£o</h2>
            <div id="status-display" class="p-4 rounded-lg flex justify-between items-center transition-colors duration-300 status-disconnected">
                <span id="connection-status" class="text-lg">Desconectado</span>
                <div id="loading-spinner" class="hidden spinner-border h-6 w-6 border-4 border-gray-500 border-r-transparent rounded-full animate-spin"></div>
            </div>
            
            <div id="qrcode-container" class="hidden mt-6 flex justify-center text-center">
                <div>
                    <p id="qr-text" class="text-lg font-medium text-red-600 mb-4">Escaneie o QR Code Abaixo para conectar o bot.</p>
                    <div id="qrcode-display" class="qr-image w-64 h-64 mx-auto p-2 bg-white rounded-xl shadow-lg">
                        <!-- QR Code ser√° injetado aqui -->
                        <div class="text-sm text-gray-500 mt-10">Carregando QR Code...</div>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end">
                <button onclick="reconnectClient()" class="btn-primary flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 13m15.356-2H15m-1.09-8h5.583m-5.584 0v5.583"></path></svg>
                    Tentar Reconectar/Novo QR
                </button>
            </div>
        </div>

        <!-- Se√ß√£o de Envio de Mensagem -->
        <div class="section">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Enviar Mensagem Manual</h2>
            <div class="space-y-4">
                <div>
                    <label for="input-number" class="block text-sm font-medium text-gray-700 mb-1">N√∫mero do WhatsApp (com c√≥digo do pa√≠s, ex: 5521987654321@c.us)</label>
                    <input type="text" id="input-number" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Ex: 5521987654321@c.us">
                </div>
                <div>
                    <label for="input-message" class="block text-sm font-medium text-gray-700 mb-1">Mensagem</label>
                    <textarea id="input-message" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Digite sua mensagem..."></textarea>
                </div>
                <button onclick="sendMessage()" id="send-btn" class="btn-primary w-full disabled:opacity-50" disabled>
                    <svg class="w-5 h-5 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    Enviar Mensagem
                </button>
                <p id="message-result" class="text-center font-medium mt-2"></p>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // CORRE√á√ÉO FINAL: Usando a URL p√∫blica confirmada do seu Render com /api
        const API_BASE_URL = 'https://automacao2-5.onrender.com/api'; 
        // =================================================================

        const statusDisplay = document.getElementById('status-display');
        const connectionStatusText = document.getElementById('connection-status');
        const loadingSpinner = document.getElementById('loading-spinner');
        const qrcodeContainer = document.getElementById('qrcode-container');
        const qrCodeDisplay = document.getElementById('qrcode-display');
        const sendButton = document.getElementById('send-btn');
        const messageResult = document.getElementById('message-result');
        let statusInterval;

        function updateStatus(connected, qrCodeBase64) {
            // Remove classes de status antigas
            statusDisplay.classList.remove('status-connected', 'status-disconnected');
            sendButton.disabled = true;
            
            if (connected) {
                // Status: Conectado
                connectionStatusText.textContent = 'Conectado';
                statusDisplay.classList.add('status-connected');
                qrcodeContainer.classList.add('hidden');
                qrCodeDisplay.innerHTML = '';
                sendButton.disabled = false;
            } else {
                // Status: Desconectado
                statusDisplay.classList.add('status-disconnected');
                
                if (qrCodeBase64) {
                    // Status: Aguardando QR Code
                    connectionStatusText.textContent = 'Aguardando QR Scan (Escaneie abaixo)';
                    qrcodeContainer.classList.remove('hidden');
                    
                    // Renderiza o QR Code em Base64
                    qrCodeDisplay.innerHTML = `<img src="data:image/png;base64,${qrCodeBase64}" alt="QR Code para WhatsApp Web">`;
                } else {
                    // Status: Desconectado (tentando reconectar ou iniciando)
                    connectionStatusText.textContent = 'Desconectado (Aguardando inicializa√ß√£o ou QR)';
                    qrcodeContainer.classList.add('hidden');
                    qrCodeDisplay.innerHTML = '';
                }
            }
        }

        async function checkStatus() {
            if (API_BASE_URL.includes('localhost')) {
                // Esta verifica√ß√£o n√£o deve mais ser acionada, pois a URL est√° correta.
                console.error("ERRO CR√çTICO: O endere√ßo da API ainda √© 'localhost'. Por favor, edite a vari√°vel API_BASE_URL no arquivo HTML para a URL p√∫blica do seu Render.");
                connectionStatusText.textContent = 'ERRO: Mudar URL da API!';
                statusDisplay.classList.add('status-disconnected');
                return;
            }

            try {
                // Indica carregamento
                loadingSpinner.classList.remove('hidden');
                
                const response = await fetch(`${API_BASE_URL}/status`);
                
                if (!response.ok) {
                    // Isso pode ocorrer se o servi√ßo do Render estiver sendo reiniciado (Bad Gateway)
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                updateStatus(data.connected, data.qrCode);

            } catch (error) {
                console.error('[CONSOLE_ERROR] Erro ao verificar o status:', error);
                // Assume desconectado se houver falha de rede ou API
                updateStatus(false, null);
                connectionStatusText.textContent = 'ERRO DE CONEX√ÉO COM O SERVIDOR';
                statusDisplay.classList.remove('status-connected', 'status-disconnected');
                statusDisplay.classList.add('status-disconnected');

            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        async function sendMessage() {
            const number = document.getElementById('input-number').value.trim();
            const message = document.getElementById('input-message').value.trim();

            if (!number || !message) {
                messageResult.textContent = 'Preencha o n√∫mero e a mensagem.';
                messageResult.style.color = '#991b1b';
                return;
            }

            messageResult.textContent = 'Enviando...';
            messageResult.style.color = '#d97706';

            try {
                const response = await fetch(`${API_BASE_URL}/send-message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ number, message })
                });

                const result = await response.json();

                if (result.success) {
                    messageResult.textContent = result.message;
                    messageResult.style.color = '#065f46';
                } else {
                    messageResult.textContent = `Falha: ${result.error}`;
                    messageResult.style.color = '#991b1b';
                }

            } catch (error) {
                console.error('Erro ao enviar mensagem:', error);
                messageResult.textContent = 'Erro de rede ao enviar mensagem.';
                messageResult.style.color = '#991b1b';
            }
        }

        async function reconnectClient() {
            try {
                const response = await fetch(`${API_BASE_URL}/reconnect`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    connectionStatusText.textContent = 'Comando de reconex√£o enviado. Aguardando novo status...';
                    statusDisplay.classList.remove('status-connected', 'status-disconnected');
                    statusDisplay.classList.add('status-disconnected');
                } else {
                    alert('Falha ao enviar comando de reconex√£o.');
                }
            } catch (error) {
                alert('Erro de rede ao tentar reconectar.');
            }
        }

        // Inicia a verifica√ß√£o de status a cada 5 segundos
        window.onload = function() {
            checkStatus();
            statusInterval = setInterval(checkStatus, 5000);
        };
    </script>
</body>
</html>


